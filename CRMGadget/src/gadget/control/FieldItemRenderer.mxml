<?xml version="1.0" encoding="utf-8"?>
<mx:HBox creationComplete="init()" xmlns:mx="http://www.adobe.com/2006/mxml" paddingLeft="8" paddingRight="8" paddingTop="4" paddingBottom="4" xmlns:control="gadget.control.*">

	<mx:Script>
	    <![CDATA[
			import gadget.dao.BookDAO;
			import gadget.dao.CustomFieldDAO;
			import gadget.dao.DAOUtils;
			import gadget.dao.Database;
			import gadget.dao.SQLListDAO;
			import gadget.i18n.i18n;
			import gadget.service.LocaleService;
			import gadget.util.FieldUtils;
			import gadget.util.ImageUtils;
			import gadget.util.Relation;
			import gadget.util.StringUtils;
			import gadget.util.Utils;
			import gadget.window.WindowManager;
			
			import mx.collections.ArrayCollection;
			import mx.controls.DateField;
			import mx.controls.NumericStepper;
			import mx.controls.TextInput;
			import mx.events.FlexEvent;
			
            private function getIndex(data:Object):int {
            	if (data.custom != null) {
					if(data.column_name.indexOf(CustomLayout.SQLLIST_CODE)>-1){
						return 7;
					} else if(data.column_name.indexOf(CustomLayout.SQLFIELD_CODE)>-1){
						return 8;
					} else if(data.column_name.indexOf(CustomLayout.HTMLFIELD_CODE)>-1){
						return 9;
					} else if(data.column_name.indexOf(CustomLayout.NEWS_CODE)>-1){
						return 10;
					} else if(data.column_name.indexOf(CustomLayout.RELATION_CODE)>-1){
						return 11;
					}else if(data.column_name.indexOf(CustomLayout.CALCULATED_CODE)>-1){
						return 13;
					}else if(data.column_name.indexOf("#")>-1){
						return 14;
					}
            		return 0;
            	}else if(data.column_name.indexOf(CustomLayout.BLOCK_DYNAMIC_CODE)>-1){
					return 15;					
				}
            	return FieldUtils.getIndexFieldItemRenderer(data);
            }
            
            private function getValue(data:Object):String {
				return (parentApplication as CustomLayout).item[data.column_name];            	
            }
			private function getSampleValue(field:String):String {
				return (parentApplication as CustomLayout).item[field];            
			}

            
			private function init():void {
				if( data){
					if(datetimeField){
						var df:DateField = new DateField();
						var objField:Object = FieldUtils.getField(data.entity, data.column_name);
						if(objField){
							df.text = objField.display_name;
							var hr:NumericStepper = new NumericStepper();
							var mm:NumericStepper = new NumericStepper();
							df.enabled = false;
							hr.enabled = false;
							mm.enabled = false;
							dataChanged(null);
							datetimeField.addChild(df);
							datetimeField.addChild(hr);
							datetimeField.addChild(mm);
						}
					}else if(dynamicblock && data.column_name.indexOf(CustomLayout.BLOCK_DYNAMIC_CODE)>-1){
						dynamicblock.text = getBlockValue();
//						var column_name:String = data.column_name;						
//						var dynamicId:String = column_name.split('_')[1];
//						var blockObj:Object = Database.blockLayoutDao.getByGadgetId(dynamicId);
//						dynamicblock.addChild(createSampleItem(blockObj.parent_field,data.entity));
//						var dependField:Object = Database.blockDependField.getDependFields(blockObj.gadget_id); 
//						if(dependField!=null){
//							var dfields:Array = Detail.getDefaultDependField(dependField);
//							if(dfields!=null){
//								for each(var f:String in dfields){
//									dynamicblock.addChild(createSampleItem(f,data.entity));
//								}
//							}
//						}
					}
				}
					
				
				
				this.addEventListener(FlexEvent.DATA_CHANGE, dataChanged);

				
				
			}
			
			
			private function createSampleItem(colName:String,entity:String):HBox{
				var fieldInfo:Object = FieldUtils.getField(entity, colName);
				var row:HBox = new HBox();
				row.percentWidth=100;
				row.autoLayout=true;
				var lbl:Label;
				if(fieldInfo==null){
					lbl = new Label();
					lbl.text = getSampleValue(fieldInfo.element_name);
					row.addChild(lbl);
					
				}else{
					lbl = new Label();
					lbl.text = fieldInfo.display_name; 
					lbl.percentWidth=30;
					row.addChild(lbl);
					switch (fieldInfo.data_type) {
						case "Text (Short)":
						case "Text (Long)":
						case "Phone":
						case "Number":
						case "Currency":
						case "Integer":
						case "Date/Time":
							var txt:TextInput = new TextInput();
							txt.percentWidth=70;
							txt.text = getSampleValue(fieldInfo.element_name);
							txt.enabled=false;
							row.addChild(txt);
							break;					
						case 'Picklist': 
							var cbo:ComboBox = new ComboBox();
							cbo.percentWidth=70;
							cbo.text = getSampleValue(fieldInfo.element_name);
							cbo.enabled=false;
							row.addChild(cbo);
							break;
						case 'Checkbox': 
							var chk:CheckBox = new CheckBox();
							chk.enabled = false;
							chk.percentWidth=70;
							chk.selected = StringUtils.isTrue(getSampleValue(fieldInfo.element_name));
							row.addChild(chk);
							break;
						
					}
				}
				return  row;
			}
			
			private function initComboRelation():void {
				
				//Create iconcomboboxs
				if(cboHBox && data){
					
					var imgLink:Image = new Image();
					imgLink.source = ImageUtils.linkIcon;
					
					var iconCbo:IconComboBox = new IconComboBox();
					iconCbo.percentWidth = 100;
					iconCbo.styleName = "backgroundRelation";
					
					
					var entity:String = data.entity;
					//iconCbo.dataProvider = Relation.getMNReferenced(data.entity);
					var listChildren:Array = Database.subSyncDao.listSubEnabledOrder(entity);
					var relations:ArrayCollection = new ArrayCollection();
					for each(var child:Object in listChildren){
						var r:Object = Relation.getMNRelation(entity,child.entity_name);
						if(r==null){
							r =  Relation.getRelation(child.entity_name,entity);
						}
						if(r!=null){
							relations.addItem(r);
						}
					}
					iconCbo.dataProvider =relations;
					iconCbo.labelFunction = function(rl:Object):String{
						if(rl.supportTable){
							return rl.entityDest;
						}else{
							return rl.entitySrc;
						}
					
					};
					
					//Load icons
					initComboEntity(iconCbo);
					
					iconCbo.addEventListener(Event.CHANGE, function(event:Event):void {
						data.custom = (event.target as ComboBox).selectedLabel;
					});
					
					iconCbo.setFocus();
					
					cboHBox.addChild(imgLink);
					cboHBox.addChild(iconCbo);
				}
			}
			
			private function initCalculatedField(event:MouseEvent,block:Boolean=false):void {
				var calculatedField:CalculatedField = new CalculatedField();
				// quickSearch.mainWindow = this;
				var textInput:TextInput = event.currentTarget as TextInput;
				calculatedField.postSave =function(label:String):void{
					if(block){
						delete data.custom;
					}
					textInput.text=label;
				};
				calculatedField.tempHeaderVal = textInput.text;
				calculatedField.dataField = data;
				WindowManager.openModal(calculatedField);
			}
			
			
		
			private function getCalculatedValue():String {
				return data==null?"":data.customField==null?"":data.customField.value;
			}
			private function getHeaderValue():String {				
				if(data!=null && data.customField!=null){
					var headerValue:String = CustomFieldDAO.getHeaderValue(data.customField.value);
					if(!StringUtils.isEmpty(headerValue)){
						data.custom = headerValue;
						return headerValue;
					} 
				}
				return data==null?"":data.custom;
			}
			
			
			private function getBlockValue():String{
				
				var label:String = "";
				if(data!=null){
					label = data.label;
					if(StringUtils.isEmpty(label)){
						var gadget_id:String = data.column_name;
						var obj:Object = Database.blockLayoutDao.getByGadgetId(gadget_id.split('_')[1]);
						if(obj!=null){
							if(data.customField!=null){
								label = CustomFieldDAO.getHeaderValue(data.customField.value);
								
							}
							
							if(StringUtils.isEmpty(label)){
								label = obj.Name;
							}
							
						}
					}
				}
				
				return label;
				
			}
			
			private function dataChanged(value:Object):void {
				if(datetimeFieldLockImage){
					datetimeFieldLockImage.includeInLayout = data.readonly;
					datetimeFieldLockImage.visible = data.readonly;
				}
				if(datetimeFieldMandatoryImage){
					datetimeFieldMandatoryImage.includeInLayout = data.mandatory;
					datetimeFieldMandatoryImage.visible = data.mandatory;
				}
				
				// when play drag drop,sometime value in text Input is confuse.
				// it happen with text field that can create more than one on layout.
				if(headerField){
					headerField.text = data.custom;
				}else if(calculateField){
					calculateField.text = data.customField==null?"":data.customField.value;
				}else if(newsField){
					newsField.text = data.custom;
				}else if(htmlField){
					htmlField.text = data.custom;
				}else if(sqlField){
					sqlField.text = data.custom;
				}else if(sqlListField){
					sqlListField.text = data.custom;
				}else if(dynamicblock){
					dynamicblock.text = getBlockValue();
				}
			}
			
			private function getComboEntityIndex(combo:ComboBox, value:String):int {
				for (var i: int = 0; i < combo.dataProvider.length; i++) {
					if ( value == combo.dataProvider[i].entityDest) {
						return i;
					}    
				}
				return 0;
			}
			
			private function initComboEntity(combo:ComboBox):void {
				if (!data.custom) {
					//data.custom = combo.dataProvider[0].entityDest;	
				}
				
				
				var selectedIndx:int =0;		
				var relations:ArrayCollection = combo.dataProvider as ArrayCollection;
				if(relations!=null){
					for (var i: int = 0; i <relations.length; i++) {
						var obj:Object = relations.getItemAt(i);
						var entity:String = obj.entityDest;
						if(obj.supportTable==null){						
							entity= obj.entitySrc;
						}
						if(entity==data.custom){
							selectedIndx=i;
						}
						obj.icon = ImageUtils.getImage(entity=="User"?"Contact":entity);
					}
				}
				//combo.selectedIndex = getComboEntityIndex(combo, data.custom);
				combo.selectedIndex = selectedIndx;
				//fixed missing value if not change anyvalue
				data.custom = combo.selectedLabel;
			}
			
//			private function isMandatoryDefault():Boolean {
//				return FieldUtils.getDefaultMandatory(data.entity,data.column_name);
//			}

			private function openSQLCreate(event:Event):void {
				var textInput:TextInput = (event.currentTarget as TextInput);
				var sqlCreate:SQLCreate = new SQLCreate();
				sqlCreate.textInput = textInput;
				sqlCreate._data = data;
				WindowManager.openModal(sqlCreate);
			}

        ]]>
    </mx:Script>

	<mx:Style>
		.backgroundQuery {
			background-color: #E7F98D;
		}
		.backgroundField {
			background-color: #E7F98D;
		}
		.backgroundHtmlField {
			background-color: #70B0F9;
		}
		.backgroundRelation {
			background-color: #CCB3DC;
		}
		
	</mx:Style>
	
	<mx:ViewStack width="100%" selectedIndex="{getIndex(data)}">
		<mx:Canvas width="100%">
			<mx:TextInput width="100%" text="{data.custom}" change="data.custom = (event.target as TextInput).text"/>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Label enabled="false" textAlign="right" width="30%" text="{FieldUtils.getField(data.entity, data.column_name).display_name}"/>		
				<!--<mx:TextInput backgroundDisabledColor="{Utils.getDisableColorLayout(data.readonly)}" enabled="false" width="70%" text="{getValue(data)}"/>-->
				<mx:TextInput enabled="false" width="70%" text="{getValue(data)}"/>
				<mx:Image visible="{data.readonly}" includeInLayout="{data.readonly}" source="{ImageUtils.lockImg}"/>
				<mx:Image visible="{data.mandatory}" includeInLayout="{ data.mandatory}" source="{ImageUtils.mandatoryImg}"/>
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Label enabled="false" textAlign="right" width="30%" text="{FieldUtils.getField(data.entity, data.column_name).display_name}"/>		
				<mx:HBox id="datetimeField"/>
				<mx:Image id="datetimeFieldLockImage" visible="{data.readonly}" includeInLayout="{data.readonly}" source="{ImageUtils.lockImg}"/>
				<mx:Image id="datetimeFieldMandatoryImage" visible="{data.mandatory}" includeInLayout="{data.mandatory}" source="{ImageUtils.mandatoryImg}"/>
			</mx:HBox>
		</mx:Canvas>		
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Label enabled="false" textAlign="right" width="30%" text="{FieldUtils.getField(data.entity, data.column_name).display_name}"/>
				<!--<mx:ComboBox fillAlphas="[1,1,1,1]" fillColors="{[Utils.getDisableColorLayout(data.readonly), Utils.getDisableColorLayout(data.readonly), Utils.getDisableColorLayout(data.readonly), Utils.getDisableColorLayout(data.readonly)]}" enabled="false" width="70%" text="{getValue(data)}"/>-->
				<mx:ComboBox enabled="false" width="70%" text="{getValue(data)}"/>
				<mx:Image visible="{data.readonly}" includeInLayout="{data.readonly}" source="{ImageUtils.lockImg}"/>
				<mx:Image visible="{ data.mandatory}" includeInLayout="{ data.mandatory}" source="{ImageUtils.mandatoryImg}"/>
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Label enabled="false" textAlign="right" width="30%" text="{FieldUtils.getField(data.entity, data.column_name).display_name}"/>
				<!--<mx:CheckBox fillAlphas="[1,1,1,1]" fillColors="{[Utils.getDisableColorLayout(data.readonly), Utils.getDisableColorLayout(data.readonly), Utils.getDisableColorLayout(data.readonly), Utils.getDisableColorLayout(data.readonly)]}" enabled="false" width="70%" selected="{getValue(data) == 'true'}"/>-->
				<mx:CheckBox enabled="false" width="70%" selected="{getValue(data) == 'true'}"/>
				<mx:Image visible="{data.readonly}" includeInLayout="{data.readonly}" source="{ImageUtils.lockImg}"/>
				<mx:Image visible="{ data.mandatory}" includeInLayout="{ data.mandatory}" source="{ImageUtils.mandatoryImg}"/>
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Label enabled="false" textAlign="right" width="30%" text="{FieldUtils.getField(data.entity, data.column_name).display_name}"/>
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Label enabled="false" textAlign="right" width="30%" text="{FieldUtils.getField(data.entity, data.column_name).display_name}"/>
				<mx:Label enabled="false" width="70%" text="{getValue(data)}"/>
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Image source="{ImageUtils.sqlListImg}" />
				<mx:TextInput id='sqlListField' doubleClickEnabled="true" width="100%" text="{data.custom}" styleName="backgroundQuery" change="data.custom = (event.target as TextInput).text" doubleClick="openSQLCreate(event)" />
			</mx:HBox>
		</mx:Canvas>
		
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Image source="{ImageUtils.sqlFieldImg}" />
				<mx:TextInput id='sqlField' width="100%" text="{data.custom}" styleName="backgroundField" change="data.custom = (event.target as TextInput).text" />
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Image source="{ImageUtils.htmlFieldImg}" />
				<mx:TextInput id='htmlField' width="100%" text="{data.custom}" styleName="backgroundHtmlField" change="data.custom = (event.target as TextInput).text" />
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Image source="{ImageUtils.newsFieldImg}" />
				<mx:TextInput id='newsField' width="100%" text="{data.custom}" styleName="backgroundHtmlField" change="data.custom = (event.target as TextInput).text" />
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%" height="100%">
			<mx:HBox width="100%" id="cboHBox" height="25" creationComplete="initComboRelation()">
				<!--
				<mx:Image source="{ImageUtils.linkIcon}" />
				<control:IconComboBox width="100%" styleName="backgroundRelation" change="data.custom = (event.target as ComboBox).selectedLabel"
					creationComplete="initComboEntity(event.target as ComboBox, data)"
					dataProvider="{Relation.getMNReferenced(data.entity)}" labelField="entityDest"/>-->
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%">
			<mx:HBox width="100%">
				<mx:Label enabled="false" textAlign="right" width="30%" text="{FieldUtils.getField(data.entity, data.column_name).display_name}"/>	
				<mx:NumericStepper enabled="false" width="50" value="{parseInt(getValue(data))}" />
				<mx:Image visible="{data.readonly}" includeInLayout="{data.readonly}" source="{ImageUtils.lockImg}"/>
				<mx:Image visible="{ data.mandatory}" includeInLayout="{ data.mandatory}" source="{ImageUtils.mandatoryImg}"/>
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%" height="100%">
			<mx:HBox width="100%">
				<mx:Image source="{ImageUtils.formulaIcon}" />
				<mx:TextInput id='calculateField' width="100%" doubleClickEnabled="true" enabled="false" text="{getCalculatedValue()}" styleName="backgroundQuery" doubleClick="initCalculatedField(event)" />
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%" height="100%">
			<mx:HBox width="100%">
				<mx:TextInput id='headerField' width="100%" toolTip="{i18n._('GLOBAL_DOUBLE_CLICK_TO_CHANGE_VALUE')}" doubleClickEnabled="true" editable="false" text="{getHeaderValue()}" doubleClick="initCalculatedField(event)" />
			</mx:HBox>
		</mx:Canvas>
		<mx:Canvas width="100%" height="100%">
			<mx:HBox width="100%">
				<mx:TextInput width="100%" id="dynamicblock" text="{getBlockValue()}" enabled="false" doubleClickEnabled="true" doubleClick="initCalculatedField(event,true)" />
				<mx:Image visible="{data.readonly}" includeInLayout="{data.readonly}" source="{ImageUtils.lockImg}"/>
			</mx:HBox>
			
		</mx:Canvas>
	</mx:ViewStack>
</mx:HBox>
